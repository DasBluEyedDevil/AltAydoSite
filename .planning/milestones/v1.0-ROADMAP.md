# Milestone v1.0: Dynamic Ship Database

**Status:** SHIPPED 2026-02-04
**Phases:** 1-7 (plus 5.1 insertion)
**Total Plans:** 26

## Overview

Replace AydoCorp's static ship database with a dynamic system powered by the FleetYards.net API. The build sequence flows from data infrastructure (sync engine, storage, API routes) through a critical migration gate (name-to-UUID conversion across all collections), into type system updates that pivot the codebase to UUID-based references, and finally through frontend work (new ship browsing UI, rewiring existing components) before cleaning up legacy code. Seven phases, strictly ordered by dependencies, delivering an always-current ship database with zero manual maintenance.

## Phases

### Phase 1: Sync Engine & Data Model

**Goal**: Ship data from FleetYards is reliably synced into MongoDB and available for downstream consumption
**Depends on**: Nothing (first phase)
**Requirements**: SYNC-01, SYNC-02, SYNC-03, SYNC-04, SYNC-05, SYNC-06, SYNC-07, DATA-01, DATA-02, DATA-03, DATA-04, DATA-05, DATA-06
**Plans**: 4 plans
**Completed**: 2026-02-03

Plans:
- [x] 01-01: Types, Zod schemas, node-cron dependency, env vars
- [x] 01-02: FleetYards API client with paginated fetch and response transform
- [x] 01-03: Ship storage module and MongoDB indexes
- [x] 01-04: Sync orchestrator, cron HTTP endpoint, instrumentation hook

**Success Criteria** (all met):
1. Sync populates `ships` collection with 500+ ship documents
2. FleetYards UUID as canonical identifier with unique index
3. Existing ship data preserved when FleetYards API is unreachable
4. Malformed records logged and skipped
5. Sync audit log records every run

### Phase 2: Ship API Routes

**Goal**: Ship data is queryable through REST endpoints with filtering, search, and batch resolution
**Depends on**: Phase 1
**Requirements**: API-01, API-02, API-03, API-04
**Plans**: 3 plans
**Completed**: 2026-02-03

Plans:
- [x] 02-01: Storage layer query functions and text search index
- [x] 02-02: Ship list and single ship lookup API routes
- [x] 02-03: Batch resolution and manufacturers API routes

**Success Criteria** (all met):
1. GET /api/ships with filtering by manufacturer, size, role, status, text search
2. GET /api/ships/[id] by UUID or slug
3. POST /api/ships/batch for multi-ship resolution
4. GET /api/ships/manufacturers with logos

### Phase 3: Data Migration

**Goal**: All existing ship references across the application are converted from name strings to FleetYards UUIDs
**Depends on**: Phase 1
**Requirements**: MIG-01, MIG-02, MIG-03, MIG-04, MIG-05, MIG-06
**Plans**: 2 plans
**Completed**: 2026-02-03

Plans:
- [x] 03-01: Ship name matching engine with multi-pass resolution and manual override map
- [x] 03-02: Migration script for all five collections with dry-run support

**Success Criteria** (all met):
1. Every user profile ship entry has valid fleetyardsId
2. Every mission/operation participant has valid fleetyardsId
3. 100% match rate (116/116 names resolved)
4. Idempotent (0 changes on second run)
5. Migration report with per-strategy match counts

### Phase 4: Type System & Image Resolution

**Goal**: The TypeScript type system and image pipeline expect UUID-based ship references and serve FleetYards CDN images
**Depends on**: Phase 3
**Requirements**: TYPE-01, TYPE-02, TYPE-03, TYPE-04, TYPE-05, TYPE-06
**Plans**: 2 plans
**Completed**: 2026-02-04

Plans:
- [x] 04-01: Type definitions (UserShip, MissionShip, MissionParticipant, OperationParticipant) and next.config.js
- [x] 04-02: Image resolution rewrite (resolveShipImage with view angles) and API validation

**Success Criteria** (all met):
1. TypeScript compilation succeeds with UUID-requiring types
2. resolveShipImage() returns FleetYards CDN URLs with fallback chain
3. next.config.js includes cdn.fleetyards.net
4. Ship images render from FleetYards CDN with CSS empty state fallback

### Phase 5: Ship Browse & Display

**Goal**: Users can browse, search, and inspect the full ship database through a rich, filterable UI
**Depends on**: Phase 2, Phase 4
**Requirements**: UI-01, UI-02, UI-03, UI-04, UI-05, UI-06, UI-07, UI-08
**Plans**: 5 plans
**Completed**: 2026-02-03

Plans:
- [x] 05-01: Data foundation: sync status API, format utilities, custom hooks
- [x] 05-02: Ship card components and grid/list container with view toggle
- [x] 05-03: Filter and search components with debounced search
- [x] 05-04: Ship detail panel with image gallery and specs display
- [x] 05-05: Page assembly: pagination, sync indicator, page orchestrator

**Success Criteria** (all met):
1. Multi-axis filtering (manufacturer, size, role, status, text search)
2. Detail view with full specs, multiple image views, manufacturer logo
3. Image gallery with view switcher/thumbnail strip
4. Data freshness indicator
5. Ship cards with classification labels and key specs

### Phase 5.1: Ship Browse Gaps (INSERTED)

**Goal**: Close the 2 verification gaps from Phase 5: manufacturer logos in UI and key specs on ship cards
**Depends on**: Phase 5
**Requirements**: UI-04, UI-05
**Plans**: 2 plans
**Completed**: 2026-02-03

Plans:
- [x] 05.1-01: Data pipeline: thread manufacturer logo field through types, schemas, transform, storage
- [x] 05.1-02: UI wiring: add manufacturer logos and ship specs to cards, detail panel, filter panel

**Success Criteria** (all met):
1. Manufacturer logo URLs captured in data model and displayed in UI
2. Ship cards display key specs (crew, cargo, speed) at a glance

### Phase 6: Frontend Integration

**Goal**: All existing application features (fleet builder, mission planner, profiles) use the new dynamic ship data
**Depends on**: Phase 2, Phase 4
**Requirements**: INT-01, INT-02, INT-03, INT-04, INT-05, INT-06
**Plans**: 5 plans
**Completed**: 2026-02-04

Plans:
- [x] 06-01: Foundation hooks (useShipBatch, useOrgFleet) and mapping utilities plus recharts
- [x] 06-02: Fleet builder rewire: FleetShipPickerModal + UserFleetBuilder using /api/ships
- [x] 06-03: Mission planner rewire: MissionShipPickerModal replacing ShipDropdownPortal
- [x] 06-04: Profile ship display and mission detail participant ships
- [x] 06-05: Org fleet composition dashboard with Recharts

**Success Criteria** (all met):
1. Fleet builder loads ships from /api/ships via FleetShipPickerModal
2. Mission planner uses MissionShipPickerModal with search
3. User profiles display ships with FleetYards images
4. Mission detail views resolve ship images from CDN
5. Org fleet composition dashboard shows aggregate fleet breakdown

### Phase 7: Cleanup & Decommission

**Goal**: All legacy static ship data and old image resolution code is removed from the codebase
**Depends on**: Phase 5, Phase 6
**Requirements**: CLN-01, CLN-02, CLN-03, CLN-04
**Plans**: 3 plans
**Completed**: 2026-02-04

Plans:
- [x] 07-01: Clean legacy imports from live files and replace placeholder images with CSS empty states
- [x] 07-02: Delete legacy files, dead code components, and placeholder image
- [x] 07-03: Fix ESLint config and full build verification with comprehensive grep scan

**Success Criteria** (all met):
1. public/data/ships.json removed
2. src/lib/ship-data.ts removed
3. ShipData.ts legacy helpers removed
4. Application builds and runs without references to removed files

---

## Milestone Summary

**Decimal Phases:**
- Phase 5.1: Ship Browse Gaps (inserted after Phase 5 to close verification gaps for UI-04 manufacturer logos and UI-05 card specs)

**Key Decisions:**
- Use FleetYards API as golden source (eliminates manual maintenance)
- FleetYards UUID as canonical ship identifier (resilient to name changes)
- Periodic sync to database, not live API calls (fast page loads, resilience)
- FleetYards CDN images directly, no R2 mirror (simpler architecture)
- Big-bang migration for existing references (clean cutover)
- Zod schemas with .passthrough() for forward compatibility
- bulkWrite with individual upsert fallback for Cosmos DB compatibility
- 80% count-drop threshold aborts sync to prevent data loss
- POST for batch endpoint (UUID arrays exceed URL length limits)
- CSS-only empty states for missing images (no placeholder PNGs)
- useReducer for centralized filter state in ship browse page
- Recharts for fleet composition dashboard visualizations

**Issues Resolved:**
- Cosmos DB text search index compatibility (mitigated by $regex fallback)
- FleetYards API response format change (view fields now flat strings, fixed in 8a8b72a)
- COSMOS_DATABASE_ID must be `aydocorp-database` (not `aydocorpdb-vcore`)
- postcss.config.js missing from project root (restored in 4900314)
- ESLint config conflict between .eslintrc.js and .eslintrc.json (deleted .json, fixed .js)
- Pre-existing @typescript-eslint violations (downgraded to warnings)

**Issues Deferred:**
- Human runtime testing for sync execution under real conditions
- Optional fleetyardsId on MissionParticipant/OperationParticipant (tighten after confirming all records migrated)

**Technical Debt Incurred:**
- Planned mission idempotency partial (3/4 re-updated on second migration run)
- MissionParticipant.fleetyardsId and OperationParticipant.fleetyardsId are optional (string?) not required

---

_For current project status, see .planning/MILESTONES.md_
