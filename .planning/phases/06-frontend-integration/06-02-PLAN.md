---
phase: 06-frontend-integration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/ships/FleetShipPickerModal.tsx
  - src/components/UserFleetBuilder.tsx
  - src/components/UserFleetBuilderWrapper.tsx
autonomous: true

must_haves:
  truths:
    - "Fleet builder 'Add Ship' opens a modal with full filter panel, search, and paginated ship grid from /api/ships"
    - "Clicking a ship in the modal instantly selects it, closes the modal, and adds it to the fleet with real fleetyardsId"
    - "Existing fleet ships display FleetYards CDN images resolved via useShipBatch"
    - "Ships with empty fleetyardsId (pre-Phase 6 legacy) gracefully fall back to name/manufacturer display only"
    - "No imports from @/lib/ship-data, @/types/ShipData, or resolveShipImageLegacy remain in fleet builder files"
  artifacts:
    - path: "src/components/ships/FleetShipPickerModal.tsx"
      provides: "Modal ship picker for fleet builder context"
      exports: ["FleetShipPickerModal"]
    - path: "src/components/UserFleetBuilder.tsx"
      provides: "Rewired fleet builder using dynamic ship data"
    - path: "src/components/UserFleetBuilderWrapper.tsx"
      provides: "Rewired fleet builder wrapper with batch resolution"
  key_links:
    - from: "src/components/ships/FleetShipPickerModal.tsx"
      to: "src/hooks/useShips.ts"
      via: "useShips hook for paginated data"
      pattern: "useShips"
    - from: "src/components/UserFleetBuilderWrapper.tsx"
      to: "src/hooks/useShipBatch.ts"
      via: "useShipBatch for resolving existing fleet"
      pattern: "useShipBatch"
    - from: "src/components/UserFleetBuilder.tsx"
      to: "src/lib/ships/mappers.ts"
      via: "shipDocumentToUserShip for selection"
      pattern: "shipDocumentToUserShip"
---

<objective>
Rewire the fleet builder to use the dynamic ship API instead of static ship data (INT-01).

Purpose: The fleet builder currently uses `getManufacturersList()` and `getShipsByManufacturer()` from static ShipData.ts. This plan replaces the manufacturer/ship dropdowns with a full modal ship picker (matching browse page UX) and upgrades existing ship display to use FleetYards CDN images.

Output: New FleetShipPickerModal component. Rewired UserFleetBuilder and UserFleetBuilderWrapper.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-frontend-integration/06-01-SUMMARY.md
@src/components/UserFleetBuilder.tsx
@src/components/UserFleetBuilderWrapper.tsx
@src/components/ships/ShipFilterPanel.tsx
@src/components/ships/ShipSearchBar.tsx
@src/components/ships/ShipCard.tsx
@src/components/ships/ShipBrowsePage.tsx
@src/hooks/useShips.ts
@src/hooks/useShipBatch.ts
@src/lib/ships/mappers.ts
@src/lib/ships/image.ts
@src/types/user.ts
@src/types/ship.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FleetShipPickerModal</name>
  <files>src/components/ships/FleetShipPickerModal.tsx</files>
  <action>
Create `src/components/ships/FleetShipPickerModal.tsx`:
- 'use client' directive
- Props: `{ isOpen: boolean; onClose: () => void; onSelect: (ship: ShipDocument) => void }`
- When `isOpen` is false, render null
- Use `createPortal` to render at `document.body` (consistent with existing ShipDropdownPortal pattern)
- Manage filter state via `useReducer` (matching ShipBrowsePage pattern from Phase 5 decision [05-05]):
  ```
  State: { page, pageSize: 12, manufacturer, size, classification, productionStatus, search }
  Actions: SET_FILTER (resets page to 1), SET_SEARCH (resets page to 1), SET_PAGE, RESET
  ```
- Use `useShips(filters)` hook for paginated data fetching
- Render as a large overlay modal (fixed inset-0, z-[9999]):
  - Semi-transparent backdrop (click to close)
  - Modal container: max-w-4xl, max-h-[85vh], flex column
  - Header: "Select Ship" title + close button (X icon)
  - Filter section: Embed `ShipFilterPanel` and `ShipSearchBar` components (reuse from Phase 5)
  - Ship grid: 3-column grid of `ShipCard` components (use grid view variant)
  - Each ShipCard onClick: call `onSelect(ship)` then `onClose()` -- instant select per locked decision
  - Pagination: simple prev/next buttons at bottom showing "Page X of Y"
  - Loading state: show skeleton grid (6-8 skeleton cards)
  - Empty state: "No ships found matching your filters"
- Use framer-motion for enter/exit animations (matching existing MobiGlas patterns):
  - Backdrop: fade in/out
  - Modal: scale from 0.95 + fade

Key implementation notes:
- Do NOT create a shared picker -- this is specifically for fleet builder context (locked decision: separate pickers)
- ShipCard's onClick should be wired to selection, not detail panel opening
- Use the `onShipClick` prop of ShipGrid/ShipCard if available, or handle click at the grid level
- Apply MobiGlas styling (mg-panel-dark, mg-primary borders) consistent with the fleet builder
  </action>
  <verify>Run `npm run type-check` -- no new type errors. File exists with correct exports.</verify>
  <done>FleetShipPickerModal renders a full modal with filter panel, search bar, paginated ship grid, and instant-select behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Rewire UserFleetBuilder and UserFleetBuilderWrapper</name>
  <files>src/components/UserFleetBuilder.tsx, src/components/UserFleetBuilderWrapper.tsx</files>
  <action>
**UserFleetBuilder.tsx** -- Full rewrite of the ship selection and display:

Remove all imports from:
- `@/types/ShipData` (getManufacturersList, getShipsByManufacturer)
- `resolveShipImageLegacy` from `@/lib/ships/image`

Add new imports:
- `FleetShipPickerModal` from `@/components/ships/FleetShipPickerModal`
- `shipDocumentToUserShip` from `@/lib/ships/mappers`
- `resolveShipImage` from `@/lib/ships/image`
- `type ShipDocument` from `@/types/ship`

Change the component props interface -- add optional resolvedShips map:
```typescript
interface UserFleetBuilderProps {
  isEditing: boolean;
  userShips: UserShip[];
  resolvedShips: Map<string, ShipDocument>;  // NEW: batch-resolved ship data
  onAddShip: (ship: UserShip) => void;
  onRemoveShip: (index: number) => void;
}
```

Replace the manufacturer/ship dropdown section (when isEditing) with:
- A single "ADD SHIP" MobiGlasButton that opens FleetShipPickerModal
- State: `const [pickerOpen, setPickerOpen] = useState(false)`
- When FleetShipPickerModal calls `onSelect(shipDoc)`:
  - Convert via `shipDocumentToUserShip(shipDoc)`
  - Call `onAddShip(userShip)`

Replace the ship display section:
- Keep the grouping by manufacturer logic (shipsByManufacturer useMemo)
- For each ship card, look up resolved data: `const resolved = resolvedShips.get(ship.fleetyardsId)`
- If resolved: use `resolveShipImage(resolved.images, 'angled')` for the image
- If NOT resolved (empty fleetyardsId or missing from map): show ship.name and ship.manufacturer only, no image (or placeholder)
- Display manufacturer logo if resolved: `resolved.manufacturer.logo` (14-16px, matching Phase 5.1 sizing)
- Show key specs if resolved: crew, size, classification from resolved ShipDocument

Remove: `selectedManufacturer`, `selectedShip`, `manufacturers`, `availableShips` state -- no longer needed.
Keep: `imageErrors`, `loadedImages` state for image load handling (same pattern, just different image sources).

**UserFleetBuilderWrapper.tsx** -- Add batch resolution:

Remove imports from:
- `@/types/ShipData` (getManufacturersList, getShipsByManufacturer -- unused but imported)

Add new imports:
- `useShipBatch` from `@/hooks/useShipBatch`
- `{ useMemo }` to React imports

Add batch resolution:
```typescript
// Collect fleetyardsIds from current ships for batch resolution
const fleetyardsIds = useMemo(() => ships.map(s => s.fleetyardsId).filter(Boolean), [ships]);
const { ships: resolvedShips } = useShipBatch(fleetyardsIds);
```

Pass `resolvedShips` to `UserFleetBuilder`:
```tsx
<UserFleetBuilder
  isEditing={isEditing}
  userShips={ships}
  resolvedShips={resolvedShips}
  onAddShip={handleAddShip}
  onRemoveShip={handleRemoveShip}
/>
```
  </action>
  <verify>Run `npm run type-check` -- no new type errors. Grep for `getManufacturersList|getShipsByManufacturer|resolveShipImageLegacy|loadShipDatabase` in both files -- zero matches. Grep for `useShipBatch|FleetShipPickerModal|shipDocumentToUserShip` -- confirms new imports present.</verify>
  <done>Fleet builder opens modal picker for ship selection, displays existing fleet with FleetYards CDN images, and has zero static ship data imports.</done>
</task>

</tasks>

<verification>
- `npm run type-check` passes with zero new errors
- `FleetShipPickerModal.tsx` exists and exports `FleetShipPickerModal`
- `UserFleetBuilder.tsx` has zero imports from `@/types/ShipData` or `@/lib/ship-data`
- `UserFleetBuilderWrapper.tsx` has zero imports from `@/types/ShipData`
- `UserFleetBuilder.tsx` uses `resolvedShips` map for image display
- `UserFleetBuilderWrapper.tsx` calls `useShipBatch`
</verification>

<success_criteria>
Fleet builder loads ships from /api/ships via modal picker. Existing fleet displays FleetYards CDN images via batch resolution. No static ship data dependencies remain.
</success_criteria>

<output>
After completion, create `.planning/phases/06-frontend-integration/06-02-SUMMARY.md`
</output>
