---
phase: 06-frontend-integration
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/ships/MissionShipPickerModal.tsx
  - src/components/dashboard/MissionPlannerForm.tsx
autonomous: true

must_haves:
  truths:
    - "Mission planner 'Add Ship' opens a modal with full filter panel, search, and paginated ship grid from /api/ships"
    - "Modal supports multi-select with checkboxes and 'Add Selected' button (matching current ShipDropdownPortal behavior)"
    - "Selected ships are converted to MissionShip with real fleetyardsId via shipDocumentToMissionShip"
    - "Ship roster cards display FleetYards CDN images instead of legacy image paths"
    - "No imports from @/lib/ship-data, @/types/ShipData (except ShipDetails type ref if still needed for templates), or resolveShipImageLegacy remain in MissionPlannerForm"
  artifacts:
    - path: "src/components/ships/MissionShipPickerModal.tsx"
      provides: "Modal ship picker for mission planner context with multi-select"
      exports: ["MissionShipPickerModal"]
    - path: "src/components/dashboard/MissionPlannerForm.tsx"
      provides: "Rewired mission planner form using dynamic ship data"
  key_links:
    - from: "src/components/ships/MissionShipPickerModal.tsx"
      to: "src/hooks/useShips.ts"
      via: "useShips hook for paginated data"
      pattern: "useShips"
    - from: "src/components/dashboard/MissionPlannerForm.tsx"
      to: "src/components/ships/MissionShipPickerModal.tsx"
      via: "MissionShipPickerModal import"
      pattern: "MissionShipPickerModal"
    - from: "src/components/dashboard/MissionPlannerForm.tsx"
      to: "src/lib/ships/mappers.ts"
      via: "shipDocumentToMissionShip for selection"
      pattern: "shipDocumentToMissionShip"
---

<objective>
Rewire the mission planner ship picker to use the dynamic ship API instead of static ship data (INT-02).

Purpose: The mission planner currently uses `loadShipDatabase()` from static ship-data.ts and renders a `ShipDropdownPortal` with local filtering. This plan replaces it with a proper modal ship picker backed by the paginated /api/ships endpoint, with multi-select support matching the current UX pattern.

Output: New MissionShipPickerModal component. Rewired MissionPlannerForm.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-frontend-integration/06-01-SUMMARY.md
@src/components/dashboard/MissionPlannerForm.tsx
@src/components/ships/ShipFilterPanel.tsx
@src/components/ships/ShipSearchBar.tsx
@src/components/ships/ShipCard.tsx
@src/hooks/useShips.ts
@src/lib/ships/mappers.ts
@src/lib/ships/image.ts
@src/types/PlannedMission.ts
@src/types/ship.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MissionShipPickerModal</name>
  <files>src/components/ships/MissionShipPickerModal.tsx</files>
  <action>
Create `src/components/ships/MissionShipPickerModal.tsx`:
- 'use client' directive
- Props: `{ isOpen: boolean; onClose: () => void; onSelectShips: (ships: ShipDocument[]) => void; existingShipNames: string[] }`
- When `isOpen` is false, render null
- Use `createPortal` to render at `document.body`
- Manage filter state via `useReducer` (matching ShipBrowsePage pattern):
  ```
  State: { page, pageSize: 12, manufacturer, size, classification, productionStatus, search }
  Actions: SET_FILTER (resets page to 1), SET_SEARCH (resets page to 1), SET_PAGE, RESET
  ```
- Use `useShips(filters)` hook for paginated data
- Track pending selections: `const [pendingSelections, setPendingSelections] = useState<Set<string>>(new Set())` -- keyed by fleetyardsId
- Render as a large overlay modal (fixed inset-0, z-[9999]):
  - Semi-transparent backdrop (click to close)
  - Modal container: max-w-4xl, max-h-[85vh], flex column
  - Header: "Select Ships" title + pending count badge + close button
  - Filter section: Reuse `ShipFilterPanel` and `ShipSearchBar`
  - Ship grid: list-style rows (not full cards -- space-efficient for multi-select):
    - Checkbox | Ship thumbnail (64x40px) | Ship name | Manufacturer | Size | Crew
    - Already-added ships show "Added" badge and disabled checkbox
    - Pending ships have highlighted row with checked checkbox
  - Footer: "Add {N} Ship(s) to Roster" button (visible when pendingSelections.size > 0)
  - Pagination: prev/next at bottom
  - Loading/empty states
- On close, clear pending selections (but preserve filters per existing ShipDropdownPortal behavior)
- On "Add Selected": filter shipDatabase for pending fleetyardsIds, call `onSelectShips(selectedShips)`, clear pending, close modal
- Use framer-motion for animations

Key differences from FleetShipPickerModal (Plan 02):
- Multi-select with checkboxes (not single instant-select)
- List rows instead of full cards (denser for multi-selection scanning)
- "Add Selected" button in footer
- existingShipNames prop to grey out already-added ships
  </action>
  <verify>Run `npm run type-check` -- no new type errors. File exists with correct exports.</verify>
  <done>MissionShipPickerModal renders a multi-select modal with filter/search, paginated ship list, checkbox selection, and "Add Selected" action.</done>
</task>

<task type="auto">
  <name>Task 2: Rewire MissionPlannerForm to use MissionShipPickerModal</name>
  <files>src/components/dashboard/MissionPlannerForm.tsx</files>
  <action>
Remove all static ship data imports and the ShipDropdownPortal component:
- Remove: `import { ShipDetails } from '@/types/ShipData'`
- Remove: `import { loadShipDatabase } from '@/lib/ship-data'`
- Remove: `import { shipDetailsToMissionShip } from '@/types/PlannedMission'` (will use new mapper instead)
- Remove: The entire `ShipDropdownPortal` component definition (lines ~157-400 in current file)
- Remove: `ships` state (`useState<ShipDetails[]>`) and `shipsLoading` state
- Remove: The `useEffect` that calls `loadShipDatabase()`

Add new imports:
- `MissionShipPickerModal` from `@/components/ships/MissionShipPickerModal`
- `shipDocumentToMissionShip` from `@/lib/ships/mappers`
- `resolveShipImage` from `@/lib/ships/image`
- `type ShipDocument` from `@/types/ship`

Replace the `addShips` function:
```typescript
const addShips = (newShips: ShipDocument[]) => {
  const currentShips = [...(formData.ships || [])];
  for (const ship of newShips) {
    const existingIndex = currentShips.findIndex(s => s.shipName === ship.name);
    if (existingIndex >= 0) {
      currentShips[existingIndex] = {
        ...currentShips[existingIndex],
        quantity: currentShips[existingIndex].quantity + 1
      };
    } else {
      currentShips.push(shipDocumentToMissionShip(ship));
    }
  }
  onInputChange('ships', currentShips);
};
```

Replace the ShipDropdownPortal usage in the JSX with MissionShipPickerModal:
```tsx
<MissionShipPickerModal
  isOpen={showShipDropdown}
  onClose={() => setShowShipDropdown(false)}
  onSelectShips={addShips}
  existingShipNames={existingShipNames}
/>
```

Remove `shipButtonRef` and `anchorRef` since the modal no longer anchors to a button position.

Update ship roster card images:
- Currently uses `ship.image || '/images/placeholder-ship.png'`
- Change to: `ship.image || '/assets/ship-placeholder.png'` (using the placeholder from Phase 4)
- Ships added via the new picker will have `ship.image` set by `shipDocumentToMissionShip` (which calls `resolveShipImage`)

Update `estimatedCrew` calculation:
- Currently looks up crew from `ships.find(sd => sd.name === ship.shipName)` using the static ship database
- Remove this lookup since static `ships` state is gone
- For now, show ship.quantity only in the crew estimate (crew data will be available via batch resolution in a future enhancement, or use a fixed estimate)
- Alternative: add crew to MissionShip type or use a simple heuristic. Simplest: remove the estimated crew display or show "Ships: {totalCount}" instead of "Est. Crew: {N}"

Keep: The `shipButtonRef` can be simplified to just a regular div wrapper (no ref needed since modal is fixed-position, not anchored).
  </action>
  <verify>Run `npm run type-check` -- no new type errors. Grep for `loadShipDatabase|ShipDropdownPortal|getShipsByManufacturer|ShipDetails` in MissionPlannerForm.tsx -- zero matches (ShipDetails import removed). Grep for `MissionShipPickerModal|shipDocumentToMissionShip` -- confirms new imports present.</verify>
  <done>Mission planner opens MissionShipPickerModal for ship selection with multi-select. Ship roster displays FleetYards CDN images. No static ship data dependencies remain.</done>
</task>

</tasks>

<verification>
- `npm run type-check` passes with zero new errors
- `MissionShipPickerModal.tsx` exists and exports `MissionShipPickerModal`
- `MissionPlannerForm.tsx` has zero imports from `@/lib/ship-data` or static `ShipData` exports
- `MissionPlannerForm.tsx` no longer contains the `ShipDropdownPortal` component
- `MissionPlannerForm.tsx` uses `MissionShipPickerModal` and `shipDocumentToMissionShip`
</verification>

<success_criteria>
Mission planner loads ships from /api/ships via modal picker with multi-select. Selected ships have real fleetyardsId values. No static ship data dependencies remain.
</success_criteria>

<output>
After completion, create `.planning/phases/06-frontend-integration/06-03-SUMMARY.md`
</output>
