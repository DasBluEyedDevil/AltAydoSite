# Phase 5.1: Ship Browse Gaps - Research

**Researched:** 2026-02-03
**Domain:** FleetYards API manufacturer data, ship card UI patterns
**Confidence:** HIGH

## Summary

This phase closes two cosmetic/informational gaps identified during Phase 5 verification: (1) manufacturer logos are not captured in the data model or displayed in the UI, and (2) ship cards do not display key specs (crew, cargo, speed) despite the data and formatting utilities being fully available.

Research confirms that the FleetYards API already provides a `logo` field on the manufacturer sub-object within each ship model response. The Zod schema's `.passthrough()` means this field already flows through validation but is discarded during the explicit field-by-field transform in `transform.ts`. The fix is to capture it in the transform and propagate it through the type system and UI.

For ship specs on cards, all data and formatting functions already exist (`formatCrew`, `formatCargo`, `formatSpeed` in `format.ts`). The gap is purely a UI wiring omission -- no new data, no new utilities, just JSX additions to `ShipCard.tsx` and `ShipCardList.tsx`.

**Primary recommendation:** Both gaps are straightforward plumbing/wiring tasks. Gap 1 (logos) requires changes at 6 touch points in the data pipeline (raw type, Zod schema, transform, ShipDocument interface, storage aggregation, UI components). Gap 2 (specs on cards) requires changes at 2 touch points (ShipCard.tsx, ShipCardList.tsx).

## Standard Stack

No new libraries are needed. All changes use existing dependencies.

### Core (Already Installed)
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| next/image | 15.3.x | Image optimization for manufacturer logos | Already used for ship images; handles CDN remote patterns |
| zod | 3.x | Schema validation at API trust boundary | Already used for FleetYards validation |
| framer-motion | 11.x | Animation (already on cards) | Already used in ShipCard, ShipCardList |

### Supporting (Already Installed)
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| @/lib/ships/format | N/A | formatCrew, formatCargo, formatSpeed | Wire into card components for Gap 2 |

### Alternatives Considered
None. No new dependencies needed.

**Installation:** No new packages required.

## Architecture Patterns

### Data Pipeline for Manufacturer Logo (Gap 1)

The manufacturer logo must be threaded through the entire data pipeline. Here is the exact chain of files that need modification, in dependency order:

```
1. src/lib/fleetyards/types.ts       -- Add logo to FleetYardsManufacturer interface
2. src/types/ship.ts                  -- Add logo to:
                                         a) ShipDocument.manufacturer interface
                                         b) FleetYardsShipSchema.manufacturer Zod schema
                                         c) ShipDocumentSchema.manufacturer Zod schema
3. src/lib/fleetyards/transform.ts   -- Capture raw.manufacturer.logo in transform output
4. src/lib/ship-storage.ts           -- Add logo to ManufacturerInfo interface and aggregation $first
5. UI components                      -- Render logo Image in ShipCard, ShipDetailPanel, ShipFilterPanel
```

### Pattern 1: Logo Field Threading
**What:** Add `logo: string | null` to every manufacturer interface/schema along the data pipeline
**When to use:** This exact pattern -- following the same field addition approach used for existing manufacturer fields (name, code, slug)

The FleetYards API returns the manufacturer `logo` field as:
- A CDN URL string when the logo exists (e.g., `https://cdn.fleetyards.net/uploads/manufacturer/logo/.../small_Aegis-....png`)
- `null` when no logo is available

**Important API finding:** Only approximately 9 out of ~37 manufacturers have logo URLs. The remaining ~28 return `null`. This means robust null/fallback handling is essential.

### Pattern 2: Spec Wiring on Cards (Gap 2)
**What:** Import format functions and add spec display JSX to existing card components
**When to use:** ShipCard.tsx (grid view) and ShipCardList.tsx (list view)

The data is already available on the `ship` prop (type `ShipDocument`). The formatting functions already exist and are already used by `ShipSpecs.tsx` in the detail panel.

### Anti-Patterns to Avoid
- **Creating a separate manufacturer collection/table:** The manufacturer data is already embedded in each ship document. Adding a separate collection would require joins and add complexity for no benefit. Keep the denormalized embedded pattern.
- **Fetching logos separately from a /manufacturers endpoint:** The logo is already in each ship's API response. Capture it during the existing sync pipeline -- no additional API calls needed.
- **Using `<img>` instead of `next/image` for logos:** The `cdn.fleetyards.net` domain is already configured in `next.config.js` remotePatterns. Use `next/image` for consistency and optimization.
- **Over-engineering logo fallback:** A simple text fallback (manufacturer code/name) is sufficient when logo is null. Do not create placeholder logo images.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Image CDN configuration | Custom image proxy | next.config.js remotePatterns (already configured for cdn.fleetyards.net) | Already done in Phase 1 |
| Number formatting | Custom formatters | formatCrew, formatCargo, formatSpeed from @/lib/ships/format | Already built in Phase 5 |
| Ship card layout | New card components | Extend existing ShipCard.tsx and ShipCardList.tsx | Already themed and animated |

**Key insight:** This phase is 100% wiring and integration. Every building block already exists.

## Common Pitfalls

### Pitfall 1: Forgetting to Update All Three Schema Layers
**What goes wrong:** Updating the TypeScript interface but forgetting the Zod schemas, causing runtime validation to strip the logo field
**Why it happens:** There are three separate type/schema definitions for manufacturer: TypeScript interface in FleetYardsManufacturer, Zod schema FleetYardsShipSchema.manufacturer, and Zod schema ShipDocumentSchema.manufacturer
**How to avoid:** Update all three in a single task. The compiler will catch TypeScript interface mismatches but NOT Zod schema omissions.
**Warning signs:** Logo field is undefined at runtime despite being in the TypeScript type. The `.passthrough()` on FleetYardsShipSchema.manufacturer means it currently flows through, but the transform explicitly maps fields -- so the transform is the actual gate.

### Pitfall 2: Not Handling null Logos (~75% of Manufacturers)
**What goes wrong:** Rendering a broken `<Image>` tag or crashing when logo is null
**Why it happens:** Developers test with popular manufacturers (Origin, Aegis, Drake) that DO have logos and miss the null case
**How to avoid:** Always render a text fallback (manufacturer code badge) when logo is null. The existing code already shows manufacturer.code as a styled badge -- keep that as the fallback.
**Warning signs:** Broken image icons appearing for ships from Tumbril, Consolidated Outland, Gatac, etc.

### Pitfall 3: Logo Images Too Large on Cards
**What goes wrong:** Manufacturer logos dominate the card layout or look pixelated
**Why it happens:** The FleetYards CDN URLs point to "small_" prefixed images that may still be larger than needed for inline card use
**How to avoid:** Use fixed small dimensions (16-20px height) with `next/image` width/height props. The images are already small format from the CDN.
**Warning signs:** Card layout shifts or text being pushed out of alignment

### Pitfall 4: Specs Making Cards Too Tall or Cluttered
**What goes wrong:** Adding crew, cargo, and speed to cards makes them visually heavy
**Why it happens:** The detail panel has room for 10 spec rows, but cards need a compact summary
**How to avoid:** Show only 2-3 key specs (crew, cargo, SCM speed) in a single condensed row. Use small text (text-xs) and muted colors to keep them secondary to the ship name/image.
**Warning signs:** Cards looking cluttered, inconsistent heights in the grid

### Pitfall 5: Re-sync Required After Data Model Change
**What goes wrong:** Existing ship documents in MongoDB do not have the logo field, so the UI shows null for all manufacturers until the next sync
**Why it happens:** The data model change only affects NEW syncs. Existing documents are not retroactively updated.
**How to avoid:** After deploying the transform change, trigger a manual re-sync via `GET /api/cron/ship-sync` (or wait for the automatic 6-hour cron). The upsert-never-delete pattern means all existing documents will be updated with the logo field on next sync.
**Warning signs:** Logo field is null in the database even for manufacturers that have logos in the API

### Pitfall 6: Manufacturer Aggregation Missing Logo Field
**What goes wrong:** The filter dropdown could show logos, but the `getManufacturers()` aggregation does not include the logo field
**Why it happens:** The MongoDB aggregation pipeline in `ship-storage.ts` explicitly lists fields to aggregate (`$first: '$manufacturer.name'`, etc.) -- logo must be added
**How to avoid:** Add `logo: { $first: '$manufacturer.logo' }` to the aggregation $group stage and include it in the $project stage. Also update the ManufacturerInfo interface.
**Warning signs:** Manufacturer logo available on ship cards but not in the filter dropdown

## Code Examples

Verified patterns from the existing codebase:

### Example 1: Adding logo to FleetYardsManufacturer (types.ts)
```typescript
// src/lib/fleetyards/types.ts -- Add logo field
export interface FleetYardsManufacturer {
  name: string;
  longName: string;
  slug: string;
  code: string;
  logo: string | null;  // <-- ADD THIS
}
```

### Example 2: Adding logo to ShipDocument.manufacturer (ship.ts)
```typescript
// src/types/ship.ts -- ShipDocument.manufacturer interface (lines 38-42)
manufacturer: {
  name: string;
  code: string;
  slug: string;
  logo: string | null;  // <-- ADD THIS
};
```

### Example 3: Adding logo to Zod schemas (ship.ts)
```typescript
// FleetYardsShipSchema.manufacturer (line 172-176)
manufacturer: z.object({
  name: z.string(),
  code: z.string().optional().default(''),
  slug: z.string(),
  logo: z.string().nullable().optional().default(null),  // <-- ADD THIS
}).passthrough(),

// ShipDocumentSchema.manufacturer (line 248-252)
manufacturer: z.object({
  name: z.string(),
  code: z.string(),
  slug: z.string(),
  logo: z.string().nullable(),  // <-- ADD THIS
}),
```

### Example 4: Capturing logo in transform (transform.ts)
```typescript
// src/lib/fleetyards/transform.ts -- manufacturer mapping (lines 70-74)
manufacturer: {
  name: raw.manufacturer.name,
  code: raw.manufacturer.code,
  slug: raw.manufacturer.slug,
  logo: raw.manufacturer.logo ?? null,  // <-- ADD THIS
},
```

### Example 5: Updating ManufacturerInfo and aggregation (ship-storage.ts)
```typescript
// ManufacturerInfo interface
export interface ManufacturerInfo {
  name: string;
  code: string;
  slug: string;
  logo: string | null;  // <-- ADD THIS
  shipCount: number;
}

// In getManufacturers() aggregation pipeline
{
  $group: {
    _id: '$manufacturer.slug',
    name: { $first: '$manufacturer.name' },
    code: { $first: '$manufacturer.code' },
    slug: { $first: '$manufacturer.slug' },
    logo: { $first: '$manufacturer.logo' },  // <-- ADD THIS
    shipCount: { $sum: 1 },
  },
},
{ $sort: { name: 1 } },
{
  $project: {
    _id: 0,
    name: 1,
    code: 1,
    slug: 1,
    logo: 1,  // <-- ADD THIS
    shipCount: 1,
  },
},
```

### Example 6: Rendering logo in ShipCard (pattern for cards)
```typescript
// Conditional logo rendering with text fallback
{ship.manufacturer.logo ? (
  <Image
    src={ship.manufacturer.logo}
    alt={ship.manufacturer.name}
    width={16}
    height={16}
    className="object-contain"
  />
) : null}
<span className="text-[rgba(var(--mg-text),0.6)] text-xs truncate">
  {ship.manufacturer.name}
</span>
```

### Example 7: Adding specs to ShipCard (pattern for card specs)
```typescript
// Import at top of ShipCard.tsx
import { formatCrew, formatCargo, formatSpeed } from '@/lib/ships/format';

// Compact spec row in card JSX (below classification badge)
<div className="flex items-center gap-2 text-[rgba(var(--mg-text),0.5)] text-xs mt-1">
  <span title="Crew">{formatCrew(ship.crew.min, ship.crew.max)}</span>
  <span>|</span>
  <span title="Cargo">{formatCargo(ship.cargo)}</span>
  <span>|</span>
  <span title="SCM Speed">{formatSpeed(ship.scmSpeed)}</span>
</div>
```

### Example 8: Adding specs to ShipCardList (pattern for list rows)
```typescript
// Import at top of ShipCardList.tsx
import { formatCrew, formatCargo, formatSpeed } from '@/lib/ships/format';

// Additional columns in the flex row (after manufacturer, before classification)
<span className="text-[rgba(var(--mg-text),0.5)] text-xs w-16 text-right hidden md:block" title="Crew">
  {formatCrew(ship.crew.min, ship.crew.max)}
</span>
<span className="text-[rgba(var(--mg-text),0.5)] text-xs w-20 text-right hidden lg:block" title="Cargo">
  {formatCargo(ship.cargo)}
</span>
<span className="text-[rgba(var(--mg-text),0.5)] text-xs w-20 text-right hidden lg:block" title="Speed">
  {formatSpeed(ship.scmSpeed)}
</span>
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| manufacturer stores only name/code/slug | Should also store logo URL | Phase 5.1 (now) | Enables visual manufacturer branding |
| Ship cards show name + manufacturer + badge | Should also show key specs | Phase 5.1 (now) | Better at-a-glance information density |

**Not deprecated/outdated -- just incomplete:**
- The existing manufacturer text display (code badge + name) should remain as the PRIMARY display, with logo as an enhancement alongside it
- The existing ShipSpecs component in the detail panel is complete and correct -- card specs are a condensed subset, not a replacement

## FleetYards API Findings

### Manufacturer Logo Field Details (HIGH confidence -- verified via live API)

| Finding | Detail |
|---------|--------|
| Field name | `logo` |
| Type | `string \| null` |
| Present on ship model response | YES -- each ship's `manufacturer` sub-object includes `logo` |
| Present on /v1/manufacturers | YES |
| CDN domain | `cdn.fleetyards.net` (already in next.config.js remotePatterns) |
| URL pattern | `https://cdn.fleetyards.net/uploads/manufacturer/logo/{uuid-path}/small_{name}.png` |
| Coverage | ~9 of ~37 manufacturers have logos (~24%) |
| Missing behavior | Field is `null` when no logo exists |
| Image format | PNG, "small_" prefix suggests pre-sized thumbnails |

### Manufacturers WITH Logos (verified)
- Aegis Dynamics (AEGS)
- Banu
- Clark Defense Systems
- Crusader Industries (CRUS)
- Drake Interplanetary (DRAK)
- Esperia (ESPR)
- Greycat Industrial (GRIN)
- Kastak Arms
- MISC
- Origin Jumpworks (ORIG) -- verified in ship model response

### Impact on Implementation
Since ~76% of manufacturers lack logos, the UI MUST gracefully degrade to text-only display (the current behavior). Logo display should be an enhancement, not a requirement. The existing manufacturer code badge + name pattern remains the primary display.

## Open Questions

1. **Logo image dimensions**
   - What we know: URLs use "small_" prefix suggesting pre-sized assets. CDN images are PNGs.
   - What's unclear: Exact pixel dimensions of the "small" variant
   - Recommendation: Use fixed `width={16} height={16}` with `object-contain` and let CSS handle sizing. Adjust after visual testing.

2. **Re-sync timing after deploy**
   - What we know: Existing MongoDB documents lack the logo field. The cron runs every 6 hours. Manual trigger available at `/api/cron/ship-sync`.
   - What's unclear: Whether to trigger immediate re-sync or wait for cron
   - Recommendation: Document that a manual sync should be triggered after deploying the transform change. Add this as a verification step.

## Sources

### Primary (HIGH confidence)
- **FleetYards API (live)** -- `GET /v1/models?page=1&perPage=3` confirmed manufacturer.logo field present in ship responses
- **FleetYards API (live)** -- `GET /v1/manufacturers` confirmed ~9/37 manufacturers have logos, null when absent
- **Codebase inspection** -- All 9 key files read and analyzed: types, schemas, transform, storage, and UI components

### Secondary (MEDIUM confidence)
- None needed -- all findings from primary sources

### Tertiary (LOW confidence)
- None

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH -- no new dependencies, all existing code inspected
- Architecture: HIGH -- exact file-by-file change chain mapped from codebase analysis
- Pitfalls: HIGH -- API response shapes verified live, null coverage quantified
- Code examples: HIGH -- all patterns derived from existing codebase conventions

**Research date:** 2026-02-03
**Valid until:** 2026-03-03 (stable -- FleetYards API schema changes infrequently)
