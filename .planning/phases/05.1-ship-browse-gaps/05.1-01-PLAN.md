---
phase: 05.1-ship-browse-gaps
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/fleetyards/types.ts
  - src/types/ship.ts
  - src/lib/fleetyards/transform.ts
  - src/lib/ship-storage.ts
autonomous: true

must_haves:
  truths:
    - "Manufacturer logo URL flows through the entire data pipeline from API to storage"
    - "Existing ship data is not broken by the schema addition"
    - "ManufacturerInfo returned by getManufacturers() includes logo field"
  artifacts:
    - path: "src/lib/fleetyards/types.ts"
      provides: "FleetYardsManufacturer with logo field"
      contains: "logo: string | null"
    - path: "src/types/ship.ts"
      provides: "ShipDocument.manufacturer.logo and both Zod schemas updated"
      contains: "logo"
    - path: "src/lib/fleetyards/transform.ts"
      provides: "Transform captures raw.manufacturer.logo"
      contains: "logo: raw.manufacturer.logo"
    - path: "src/lib/ship-storage.ts"
      provides: "ManufacturerInfo.logo and aggregation pipeline includes logo"
      contains: "logo"
  key_links:
    - from: "src/lib/fleetyards/transform.ts"
      to: "src/types/ship.ts"
      via: "manufacturer.logo field mapped from raw to ShipDocument"
      pattern: "logo: raw\\.manufacturer\\.logo"
    - from: "src/lib/ship-storage.ts"
      to: "src/types/ship.ts"
      via: "ManufacturerInfo interface includes logo"
      pattern: "logo.*\\$first.*manufacturer\\.logo"
---

<objective>
Thread the manufacturer logo field through the entire data pipeline so that logo URLs from the FleetYards API are captured, stored, and available for UI rendering.

Purpose: The FleetYards API provides manufacturer logo URLs on ~24% of manufacturers. Currently the transform discards this field. This plan adds it to every layer: raw types, Zod schemas, transform, storage interface, and aggregation pipeline.

Output: Updated data pipeline files with logo field at every layer. After a re-sync, ship documents in MongoDB will contain manufacturer.logo (string URL or null).
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-ship-browse-gaps/05.1-RESEARCH.md
@src/lib/fleetyards/types.ts
@src/types/ship.ts
@src/lib/fleetyards/transform.ts
@src/lib/ship-storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add logo field to types, Zod schemas, and transform</name>
  <files>
    src/lib/fleetyards/types.ts
    src/types/ship.ts
    src/lib/fleetyards/transform.ts
  </files>
  <action>
    Add `logo: string | null` to the manufacturer object at ALL FOUR definition sites:

    1. **src/lib/fleetyards/types.ts** -- FleetYardsManufacturer interface (line ~33):
       Add `logo: string | null;` after the `code: string;` field.

    2. **src/types/ship.ts** -- ShipDocument.manufacturer interface (lines 38-42):
       Add `logo: string | null;` after `slug: string;` inside the manufacturer block.

    3. **src/types/ship.ts** -- FleetYardsShipSchema.manufacturer Zod object (lines 172-176):
       Add `logo: z.string().nullable().optional().default(null),` inside the manufacturer z.object before `.passthrough()`.

    4. **src/types/ship.ts** -- ShipDocumentSchema.manufacturer Zod object (lines 248-252):
       Add `logo: z.string().nullable(),` inside the manufacturer z.object.

    5. **src/lib/fleetyards/transform.ts** -- manufacturer mapping (lines 70-74):
       Add `logo: raw.manufacturer.logo ?? null,` after the `slug` line in the manufacturer object.

    IMPORTANT: Do NOT remove any existing fields. This is purely additive. The `.passthrough()` on FleetYardsShipSchema.manufacturer already lets the logo field through validation, but the transform explicitly maps fields -- so the transform is the actual gate that must be updated.
  </action>
  <verify>
    Run `npm run type-check` and confirm zero errors. The TypeScript compiler will catch any interface/schema mismatches between the 4 definition sites.
  </verify>
  <done>
    All 4 manufacturer type/schema definitions include `logo: string | null`. The transform captures `raw.manufacturer.logo ?? null`. Type-check passes cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add logo to ManufacturerInfo and aggregation pipeline</name>
  <files>
    src/lib/ship-storage.ts
  </files>
  <action>
    Update the ManufacturerInfo interface and getManufacturers() aggregation to include the logo field:

    1. **ManufacturerInfo interface** (line ~269-274):
       Add `logo: string | null;` after `slug: string;` (before `shipCount: number;`).

    2. **getManufacturers() $group stage** (line ~429-434):
       Add `logo: { $first: '$manufacturer.logo' },` after the `slug` line in the $group object.

    3. **getManufacturers() $project stage** (line ~439-443):
       Add `logo: 1,` after `slug: 1,` in the $project object.

    No changes needed to the /api/ships/manufacturers route -- it serializes whatever getManufacturers() returns, so the logo field will automatically appear in the JSON response.
  </action>
  <verify>
    Run `npm run type-check` and confirm zero errors. Verify that ManufacturerInfo now has 5 fields (name, code, slug, logo, shipCount).
  </verify>
  <done>
    ManufacturerInfo interface includes `logo: string | null`. The aggregation pipeline captures `$first: '$manufacturer.logo'` and projects it. The /api/ships/manufacturers endpoint will return logo URLs (or null) for each manufacturer after the next sync.
  </done>
</task>

</tasks>

<verification>
1. `npm run type-check` passes with zero errors
2. Grep for `logo` in all 4 modified files confirms the field is present at every pipeline layer:
   - `grep -n "logo" src/lib/fleetyards/types.ts` shows logo in FleetYardsManufacturer
   - `grep -n "logo" src/types/ship.ts` shows logo in ShipDocument.manufacturer, FleetYardsShipSchema, ShipDocumentSchema
   - `grep -n "logo" src/lib/fleetyards/transform.ts` shows logo mapped from raw
   - `grep -n "logo" src/lib/ship-storage.ts` shows logo in ManufacturerInfo, $group, $project
</verification>

<success_criteria>
- The manufacturer logo field exists at all 6 definition/usage sites (FleetYardsManufacturer, ShipDocument.manufacturer, FleetYardsShipSchema, ShipDocumentSchema, transform, ManufacturerInfo + aggregation)
- TypeScript type-check passes with zero errors
- No existing fields removed or renamed -- purely additive change
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-ship-browse-gaps/05.1-01-SUMMARY.md`
</output>
