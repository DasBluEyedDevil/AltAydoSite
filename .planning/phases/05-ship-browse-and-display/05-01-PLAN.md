---
phase: 05-ship-browse-and-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/ships/sync-status/route.ts
  - src/lib/ships/format.ts
  - src/hooks/useShips.ts
  - src/hooks/useShipDetail.ts
  - src/hooks/useSyncStatus.ts
autonomous: true

must_haves:
  truths:
    - "Sync status API returns last sync timestamp and ship count"
    - "useShips hook fetches paginated ship data with filter parameters"
    - "useShipDetail hook fetches a single ship by ID"
    - "useSyncStatus hook fetches sync freshness data"
    - "formatRelativeTime converts timestamps to human-readable strings like '2 hours ago'"
  artifacts:
    - path: "src/app/api/ships/sync-status/route.ts"
      provides: "GET /api/ships/sync-status endpoint"
      exports: ["GET"]
    - path: "src/lib/ships/format.ts"
      provides: "formatRelativeTime, formatDimensions, formatCrew, formatCargo utilities"
      min_lines: 30
    - path: "src/hooks/useShips.ts"
      provides: "useShips custom hook with filter state integration"
      min_lines: 40
    - path: "src/hooks/useShipDetail.ts"
      provides: "useShipDetail custom hook for single ship fetch"
      min_lines: 20
    - path: "src/hooks/useSyncStatus.ts"
      provides: "useSyncStatus custom hook for sync freshness"
      min_lines: 15
  key_links:
    - from: "src/app/api/ships/sync-status/route.ts"
      to: "src/lib/ship-storage.ts"
      via: "getLatestSyncStatus() call"
      pattern: "getLatestSyncStatus"
    - from: "src/hooks/useShips.ts"
      to: "/api/ships"
      via: "fetch with URLSearchParams"
      pattern: "fetch.*api/ships"
    - from: "src/hooks/useShipDetail.ts"
      to: "/api/ships/[id]"
      via: "fetch by ship ID"
      pattern: "fetch.*api/ships/"
    - from: "src/hooks/useSyncStatus.ts"
      to: "/api/ships/sync-status"
      via: "fetch sync status"
      pattern: "fetch.*api/ships/sync-status"
---

<objective>
Build the data foundation for the ship browse UI: a sync status API endpoint, formatting utilities, and three custom React hooks that all downstream UI components will consume.

Purpose: Every UI component in Plans 02-05 needs data from the ship API. This plan creates the data access layer so that all subsequent plans can build UI components that simply call hooks and format data -- no raw fetch logic in components.

Output: One new API route, one utility module, three custom hooks -- all tested via type-check.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ship-browse-and-display/05-RESEARCH.md

Key source files:
@src/lib/ship-storage.ts (getLatestSyncStatus function, ShipQueryOptions, ShipQueryResult interfaces)
@src/types/ship.ts (ShipDocument, SyncStatusDocument interfaces)
@src/lib/ships/image.ts (resolveShipImage, ShipImageView, ShipImages types)
@src/app/api/ships/route.ts (existing ship list API pattern to follow)
@src/hooks/useEvents.ts (existing hook pattern to follow)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sync status API endpoint and format utilities</name>
  <files>
    src/app/api/ships/sync-status/route.ts
    src/lib/ships/format.ts
  </files>
  <action>
    Create GET /api/ships/sync-status endpoint:
    - Import `getLatestSyncStatus` from `@/lib/ship-storage`
    - Call getLatestSyncStatus() and return the result as JSON
    - If result is null, return `{ lastSyncAt: null, shipCount: 0, status: 'unknown' }`
    - Return only the fields the UI needs: `{ lastSyncAt, shipCount, status, syncVersion }`
    - Set Cache-Control: `public, max-age=60, stale-while-revalidate=30` (refresh more often than ship data since it shows recency)
    - Handle errors with try/catch, return 500 with `{ error: message }`
    - No authentication required (public reference data)

    Create src/lib/ships/format.ts with these utilities:
    - `formatRelativeTime(date: Date | string): string` -- converts timestamp to "just now", "5 minutes ago", "2 hours ago", "3 days ago", or falls back to toLocaleDateString() for >30 days. Implementation from RESEARCH.md code example.
    - `formatDimensions(length: number, beam: number, height: number): string` -- returns "L x W x H m" (e.g., "26.5 x 28.5 x 8.0 m"). Skip zeros (return "N/A" if all three are 0).
    - `formatCrew(min: number, max: number): string` -- returns "1" if min===max, "1-3" if different, "N/A" if both 0.
    - `formatCargo(scu: number): string` -- returns "46 SCU" or "None" if 0.
    - `formatSpeed(scmSpeed: number | null): string` -- returns "220 m/s" or "N/A" if null/0.
    - `formatProductionStatus(status: string): string` -- converts slug to display: "flight-ready" -> "Flight Ready", "in-concept" -> "In Concept", "in-production" -> "In Production". Use simple replace('-', ' ') + title case.
    - `formatSize(size: string): string` -- title case: "small" -> "Small", "capital" -> "Capital".
    - All functions are pure (no side effects, no imports needed).
    - Export all functions as named exports.
  </action>
  <verify>
    Run `npm run type-check` -- no errors in the new files.
    Manually verify: `curl http://localhost:3000/api/ships/sync-status` returns JSON with lastSyncAt field (requires dev server running).
  </verify>
  <done>
    GET /api/ships/sync-status returns sync status JSON with lastSyncAt, shipCount, status fields. All format utility functions are exported and type-safe.
  </done>
</task>

<task type="auto">
  <name>Task 2: Custom data hooks (useShips, useShipDetail, useSyncStatus)</name>
  <files>
    src/hooks/useShips.ts
    src/hooks/useShipDetail.ts
    src/hooks/useSyncStatus.ts
  </files>
  <action>
    Create src/hooks/useShips.ts:
    - Define `ShipFilters` interface: `{ page: number; pageSize: number; manufacturer?: string; size?: string; classification?: string; productionStatus?: string; search?: string; }`
    - Define `ShipQueryResult` interface locally (matching API response): `{ items: ShipDocument[]; total: number; page: number; pageSize: number; totalPages: number; }`
    - Import ShipDocument from `@/types/ship`
    - Hook signature: `useShips(filters: ShipFilters): { data: ShipQueryResult | null; isLoading: boolean; error: string | null; }`
    - useEffect that builds URLSearchParams from filters (skip undefined/empty values), fetches `/api/ships?${params}`, sets data/error/loading
    - Dependencies array includes ALL filter fields to re-fetch when any filter changes
    - On fetch start: set isLoading=true, clear error
    - On success: set data, clear error, set isLoading=false
    - On error: set error message, set isLoading=false
    - Use AbortController to cancel inflight requests when filters change (prevents race conditions)
    - Return cleanup function that aborts the controller

    Create src/hooks/useShipDetail.ts:
    - Hook signature: `useShipDetail(shipId: string | null): { ship: ShipDocument | null; isLoading: boolean; error: string | null; }`
    - Only fetch when shipId is truthy (non-null, non-empty)
    - Fetch from `/api/ships/${shipId}`
    - Same loading/error pattern as useShips
    - Use AbortController for cleanup
    - When shipId changes to null, set ship to null without fetching

    Create src/hooks/useSyncStatus.ts:
    - Define `SyncStatus` interface: `{ lastSyncAt: string | null; shipCount: number; status: string; syncVersion: number; }`
    - Hook signature: `useSyncStatus(): { syncStatus: SyncStatus | null; isLoading: boolean; }`
    - Fetch from `/api/ships/sync-status` on mount
    - Re-fetch every 5 minutes (setInterval with 300000ms) to keep freshness indicator current
    - Cleanup: clear interval + abort controller
    - No error state exposed (freshness indicator is non-critical; just show nothing on error)

    All hooks must be 'use client' compatible (no 'use server' directives). Import React hooks from 'react'.
  </action>
  <verify>
    Run `npm run type-check` -- no errors in the new hook files.
    Verify imports resolve: ShipDocument from @/types/ship exists.
  </verify>
  <done>
    Three custom hooks export correctly: useShips returns paginated ship data with loading/error states, useShipDetail fetches a single ship, useSyncStatus polls sync freshness every 5 minutes. All hooks use AbortController for cleanup.
  </done>
</task>

</tasks>

<verification>
- `npm run type-check` passes with zero errors in new files
- All new files follow existing patterns (compare hook structure to src/hooks/useEvents.ts)
- No new dependencies added to package.json
</verification>

<success_criteria>
- GET /api/ships/sync-status endpoint exists and returns sync metadata
- Format utilities handle edge cases (zero values, null, empty strings)
- useShips hook builds correct URLSearchParams from all filter combinations
- useShipDetail only fetches when shipId is provided
- useSyncStatus polls on interval and cleans up properly
- All files pass TypeScript type checking
</success_criteria>

<output>
After completion, create `.planning/phases/05-ship-browse-and-display/05-01-SUMMARY.md`
</output>
