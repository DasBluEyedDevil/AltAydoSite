---
phase: 02-ship-api-routes
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/api/ships/batch/route.ts
  - src/app/api/ships/manufacturers/route.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/ships/batch resolves multiple ships from an array of FleetYards UUIDs in a single request"
    - "POST /api/ships/batch rejects arrays larger than 50 UUIDs with a 400 error"
    - "POST /api/ships/batch rejects non-UUID strings with a 400 error"
    - "GET /api/ships/manufacturers returns all manufacturers with ship counts sorted alphabetically"
    - "Both endpoints return responses without requiring authentication"
  artifacts:
    - path: "src/app/api/ships/batch/route.ts"
      provides: "POST /api/ships/batch endpoint with Zod-validated UUID array"
      exports: ["POST"]
    - path: "src/app/api/ships/manufacturers/route.ts"
      provides: "GET /api/ships/manufacturers endpoint"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/ships/batch/route.ts"
      to: "src/lib/ship-storage.ts"
      via: "getShipsByFleetyardsIds() function call"
      pattern: "shipStorage\\.getShipsByFleetyardsIds"
    - from: "src/app/api/ships/manufacturers/route.ts"
      to: "src/lib/ship-storage.ts"
      via: "getManufacturers() function call"
      pattern: "shipStorage\\.getManufacturers"
---

<objective>
Create the batch ship resolution and manufacturers list API routes (API-03 and API-04).

Purpose: The batch endpoint enables fleet displays and mission rosters to resolve multiple ships in a single request instead of N individual calls. The manufacturers endpoint enables filter dropdowns and manufacturer browsing in the UI.

Output: Two Next.js App Router route files implementing POST /api/ships/batch and GET /api/ships/manufacturers.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ship-api-routes/02-RESEARCH.md
@.planning/phases/02-ship-api-routes/02-01-SUMMARY.md

@src/lib/ship-storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create POST /api/ships/batch route (API-03)</name>
  <files>src/app/api/ships/batch/route.ts</files>
  <action>
Create `src/app/api/ships/batch/route.ts` with a single POST handler.

**Imports:**
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';
import * as shipStorage from '@/lib/ship-storage';
```

**Zod body schema** (define at top of file):
```typescript
const BatchQuerySchema = z.object({
  ids: z.array(z.string().uuid()).min(1).max(50),
});
```

**POST handler:**
1. Parse request body with `await request.json()`
2. Validate with `BatchQuerySchema.safeParse(body)`
3. If parse fails, return 400 with `{ error: 'Invalid request body', details: parseResult.error.errors.map(e => \`${e.path.join('.')}: ${e.message}\`) }`
4. Call `shipStorage.getShipsByFleetyardsIds(parseResult.data.ids)`
5. Return `{ items: ships }` as JSON with 200 status
6. Set `Cache-Control: no-store` on response (POST requests should not be cached)
7. Wrap in try/catch. On JSON parse error from `request.json()`, return 400 with `{ error: 'Invalid JSON body' }`. On other errors, log with `[ships/batch]` prefix, return 500.

**Why POST instead of GET:** Passing an array of up to 50 UUIDs in query string parameters is awkward and may exceed URL length limits. POST with a JSON body is cleaner. This is a read operation using POST for pragmatic reasons, which is an accepted pattern for batch lookups.

**No authentication required.** Ship data is public reference data.

**Response shape note:** Return `{ items: ships }` (array wrapper) for consistency with the list endpoint pattern, even though there is no pagination here.
  </action>
  <verify>
Run `npm run type-check` to confirm no TypeScript errors. Verify the file exports a POST function.
  </verify>
  <done>
POST /api/ships/batch route exists, validates a JSON body with Zod (array of 1-50 UUIDs), resolves ships via shipStorage.getShipsByFleetyardsIds, returns { items: ships[] }, no auth required.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GET /api/ships/manufacturers route (API-04)</name>
  <files>src/app/api/ships/manufacturers/route.ts</files>
  <action>
Create `src/app/api/ships/manufacturers/route.ts` with a single GET handler.

**Imports:**
```typescript
import { NextRequest, NextResponse } from 'next/server';
import * as shipStorage from '@/lib/ship-storage';
```

**GET handler:**
1. Call `shipStorage.getManufacturers()` -- returns `ManufacturerInfo[]` (name, code, slug, shipCount) sorted alphabetically
2. Return `{ items: manufacturers }` as JSON with 200 status
3. Set `Cache-Control: public, max-age=3600` on response (manufacturers change even less frequently than ships -- 1 hour cache)
4. Wrap in try/catch. On error, log with `[ships/manufacturers]` prefix, return 500

**No authentication required.** No query parameters needed.

**No pagination needed.** There are ~33 manufacturers in the FleetYards database. This will always be a small list.

**Note on logos:** The ShipDocument.manufacturer does not include logo URLs. The manufacturers endpoint returns name, code, slug, and shipCount only. Logo resolution is deferred to Phase 4 (image resolution) or can be handled client-side by constructing FleetYards CDN URLs from the manufacturer slug. Do NOT attempt to fetch logos from FleetYards API in this route.
  </action>
  <verify>
Run `npm run type-check` to confirm no TypeScript errors. Verify the file exports a GET function.
  </verify>
  <done>
GET /api/ships/manufacturers route exists, delegates to shipStorage.getManufacturers, returns { items: ManufacturerInfo[] } with 1-hour cache, no auth required, no pagination.
  </done>
</task>

</tasks>

<verification>
1. `npm run type-check` passes with no errors related to the new route files
2. `src/app/api/ships/batch/route.ts` exists and exports POST
3. `src/app/api/ships/manufacturers/route.ts` exists and exports GET
4. Batch route validates UUID array with Zod (max 50)
5. Neither route imports auth-related modules
6. Manufacturers route sets Cache-Control: public, max-age=3600
7. Batch route sets Cache-Control: no-store
</verification>

<success_criteria>
- POST /api/ships/batch validates UUID array (1-50 items) and returns matching ships
- GET /api/ships/manufacturers returns all manufacturers with ship counts
- Both endpoints are public (no auth)
- Batch endpoint rejects invalid UUIDs and oversized arrays with 400
- Manufacturers endpoint caches aggressively (1 hour)
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-ship-api-routes/02-03-SUMMARY.md`
</output>
