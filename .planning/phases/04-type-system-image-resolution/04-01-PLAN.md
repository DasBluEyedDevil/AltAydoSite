---
phase: 04-type-system-image-resolution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/user.ts
  - src/types/PlannedMission.ts
  - src/types/Mission.ts
  - src/types/Operation.ts
  - src/types/mission-builder.ts
  - next.config.js
autonomous: true

must_haves:
  truths:
    - "UserShip type requires fleetyardsId as a string and makes image optional"
    - "MissionShip type requires fleetyardsId as a string and makes image optional"
    - "MissionParticipant type accepts optional fleetyardsId"
    - "OperationParticipant type accepts optional fleetyardsId"
    - "MissionParticipantDraft type accepts optional fleetyardsId"
    - "next.config.js at project root includes cdn.fleetyards.net in remotePatterns"
    - "npm run type-check passes with no new errors"
  artifacts:
    - path: "src/types/user.ts"
      provides: "UserShip with fleetyardsId: string, image?: string"
      contains: "fleetyardsId: string"
    - path: "src/types/PlannedMission.ts"
      provides: "MissionShip with fleetyardsId: string, image?: string"
      contains: "fleetyardsId: string"
    - path: "src/types/Mission.ts"
      provides: "MissionParticipant with fleetyardsId?: string"
      contains: "fleetyardsId?: string"
    - path: "src/types/Operation.ts"
      provides: "OperationParticipant with fleetyardsId?: string"
      contains: "fleetyardsId?: string"
    - path: "src/types/mission-builder.ts"
      provides: "MissionParticipantDraft with fleetyardsId?: string"
      contains: "fleetyardsId?: string"
    - path: "next.config.js"
      provides: "Next.js config with FleetYards CDN remotePatterns and discord.js webpack config"
      contains: "cdn.fleetyards.net"
  key_links:
    - from: "next.config.js"
      to: "cdn.fleetyards.net"
      via: "remotePatterns hostname entry"
      pattern: "hostname.*cdn\\.fleetyards\\.net"
    - from: "src/types/PlannedMission.ts"
      to: "shipDetailsToMissionShip"
      via: "helper function return shape"
      pattern: "fleetyardsId.*ship\\.fleetyardsId"
---

<objective>
Update all TypeScript type definitions to include fleetyardsId and restore next.config.js to the project root with FleetYards CDN support.

Purpose: Phase 3 already wrote fleetyardsId into the MongoDB data (116 references). The TypeScript types must reflect this so the field is recognized, persisted on saves, and enforced going forward. The next.config.js must be restored to the project root (it was accidentally moved to scripts/) with cdn.fleetyards.net in remotePatterns so Next.js Image component can load FleetYards ship images.

Output: Updated type definitions for UserShip, MissionShip, MissionParticipant, OperationParticipant, MissionParticipantDraft, and a restored next.config.js at the project root.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-type-system-image-resolution/04-RESEARCH.md
@src/types/user.ts
@src/types/PlannedMission.ts
@src/types/Mission.ts
@src/types/Operation.ts
@src/types/mission-builder.ts
@scripts/next.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fleetyardsId to all ship-referencing types</name>
  <files>
    src/types/user.ts
    src/types/PlannedMission.ts
    src/types/Mission.ts
    src/types/Operation.ts
    src/types/mission-builder.ts
  </files>
  <action>
Update five type definition files to include fleetyardsId. The strategy is ADDITIVE -- add fleetyardsId, make image optional where it was required, but do NOT remove any existing fields. This prevents breaking the ~7 component files that still reference ship.image (those get rewired in Phases 5-6).

**src/types/user.ts -- UserShip interface (line 42-46):**
- Add `fleetyardsId: string;` after the `name` field (before `image`)
- Change `image: string;` to `image?: string;` (optional)
- Add comment: `// Kept optional for transition; removed in Phase 7`
- The User and UserResponse interfaces remain unchanged (they reference UserShip via ships?: UserShip[])

**src/types/PlannedMission.ts -- MissionShip interface (line 17-27):**
- Add `fleetyardsId: string;` field after `role?: string[]` and before `image`
- Change `image: string;` to `image?: string;`
- Add comment on image: `// Kept optional for transition; removed in Phase 7`
- Update `shipDetailsToMissionShip()` helper function (line 171-181): The ShipDetails type does NOT have fleetyardsId, so set `fleetyardsId: ''` as a placeholder. Add a comment: `// Empty placeholder -- callers must set fleetyardsId from ship lookup`. This prevents the function from being used to create ships without a fleetyardsId silently. The function still compiles because fleetyardsId is a string (empty is valid for the type, but callers should populate it).

**src/types/Mission.ts -- MissionParticipant interface (line 6-17):**
- Add `fleetyardsId?: string;` after `manufacturer?: string;` and before `image?: string;`
- image is already optional here, no change needed for it
- Add comment: `// FleetYards UUID (optional -- not all participants have ships)`

**src/types/Operation.ts -- OperationParticipant interface (line 3-9):**
- Add `fleetyardsId?: string;` after `shipManufacturer?: string;` and before `role: string;`
- Add comment: `// FleetYards UUID (optional)`

**src/types/mission-builder.ts -- MissionParticipantDraft interface (line 43-54):**
- Add `fleetyardsId?: string;` after `manufacturer?: string;` and before `image?: string;`
- Add comment: `// FleetYards UUID (optional during drafting)`
  </action>
  <verify>
Run `npm run type-check` from project root. It must pass (exit code 0) with no new errors related to the type changes. Pre-existing errors (if any) from discord.js/unrelated areas are acceptable.
  </verify>
  <done>
All five type files contain fleetyardsId fields. UserShip.fleetyardsId is required (string). MissionShip.fleetyardsId is required (string). MissionParticipant.fleetyardsId is optional. OperationParticipant.fleetyardsId is optional. MissionParticipantDraft.fleetyardsId is optional. UserShip.image and MissionShip.image are now optional (string?). npm run type-check passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Restore next.config.js to project root with FleetYards CDN</name>
  <files>next.config.js</files>
  <action>
Create `next.config.js` at the project root (it does NOT currently exist -- it was moved to `scripts/next.config.js` in commit 2ea1e1b).

Use `scripts/next.config.js` as the base content with these modifications:

1. **Add FleetYards CDN to remotePatterns** -- Insert as the FIRST entry in the remotePatterns array:
```javascript
{
  protocol: 'https',
  hostname: 'cdn.fleetyards.net',
  pathname: '/uploads/**',
},
```

2. **Remove `unoptimized: false`** from images config (it is the default and the research example omits it; keeping it explicit is fine but the research config does not include it).

3. **Keep everything else identical** to scripts/next.config.js:
   - `output: process.env.NODE_ENV === 'production' ? 'standalone' : undefined`
   - `poweredByHeader: false`
   - `typescript.ignoreBuildErrors: false`
   - `eslint.ignoreDuringBuilds: false`
   - `images.dangerouslyAllowSVG: true`
   - Existing AydoCorp remotePatterns (images.aydocorp.space and aydocorp.space/images)
   - webpack config for discord.js externals (utf-8-validate, bufferutil, zlib-sync)
   - redirects (traderoutes -> operations)
   - headers (X-Frame-Options, X-Content-Type-Options, Referrer-Policy, Cache-Control)
   - Bundle analyzer conditional wrapper at bottom

Do NOT delete scripts/next.config.js -- it may be referenced by other scripts. Just create the new file at the root.

The final file should be standard CommonJS (`module.exports = ...`) matching the existing pattern.
  </action>
  <verify>
1. Verify `next.config.js` exists at project root: `ls next.config.js`
2. Verify it contains FleetYards CDN: search for `cdn.fleetyards.net` in the file
3. Verify it contains webpack discord.js config: search for `zlib-sync` in the file
4. Run `npm run type-check` to confirm no regressions
  </verify>
  <done>
next.config.js exists at project root with cdn.fleetyards.net in remotePatterns alongside existing AydoCorp CDN patterns. The webpack config for discord.js is preserved. All existing redirects and headers are intact.
  </done>
</task>

</tasks>

<verification>
1. `npm run type-check` passes with exit code 0
2. `grep -r "fleetyardsId" src/types/user.ts src/types/PlannedMission.ts src/types/Mission.ts src/types/Operation.ts src/types/mission-builder.ts` shows fleetyardsId in all five files
3. `grep "cdn.fleetyards.net" next.config.js` returns a match
4. `grep "image?" src/types/user.ts src/types/PlannedMission.ts` confirms image is optional in UserShip and MissionShip
</verification>

<success_criteria>
- All five type files have fleetyardsId fields (required for UserShip and MissionShip, optional for MissionParticipant, OperationParticipant, MissionParticipantDraft)
- UserShip.image and MissionShip.image changed from required to optional
- next.config.js exists at project root with cdn.fleetyards.net/uploads/** in remotePatterns
- npm run type-check passes
- No existing fields removed from any type (additive only)
- shipDetailsToMissionShip() helper updated to include fleetyardsId placeholder
</success_criteria>

<output>
After completion, create `.planning/phases/04-type-system-image-resolution/04-01-SUMMARY.md`
</output>
